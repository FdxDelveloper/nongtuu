import MemoryService from "feathers-memory"
import request from "request-promise-native"

// API "Secrets". Feel free to steal them. I don't give a single F.
// TODO: Move that to Environment Variables, but I ain't got no time

const CHANNEL_TOKEN = "UuQd6RmSRQppG/0g6xc4Xh9GVigTR0/CqBV7afFJpYbRoMp0TGP00T1UNbEZmeDgM5VMEYF+ucWkGJwHwVoQP0cGzhAeg0RCToj8c2Pk2qCZI1/wkh6tTWlOtt9uFIMwKiqj5N/3bTCjfII3HQki3QdB04t89/1O/w1cDnyilFU="
const TEST_USER_ID = "U33084216cc1a00f7aa27632bec769356"

// SDK for interfacing with the LINE Messaging API
// NOTE: Why the heck are the Official SDKs deprecated? Like, seriously dude? -.-

const defaultAction = [{
  type: "postback",
  label: "р╕лр╕Щр╕╡р╣Йр╕Ър╕▒р╕Хр╕гр╣Ар╕Др╕гр╕Фр╕┤р╕Х",
  data: "action=buy&itemid=123"
}, {
  type: "postback",
  label: "р╕Бр╕Ор╕лр╕бр╕▓р╕вр╕Чр╕╡р╣Ир╕Фр╕┤р╕Щ",
  data: "action=add&itemid=123"
}]

const defaultImage = `https://images.unsplash.com/reserve/uvRBqDAfQfaGPJiI6lVS_R0001899.jpg?dpr=1&auto=format&fit=crop&w=1500&h=994&q=80&cs=tinysrgb&crop=`

class LineMessaging {

  constructor(token) {
    this.token = token;
  }

  post(endpoint, body) {
    request({
      method: "POST",
      uri: `https://api.line.me/v2/bot/${endpoint}`,
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    }).auth(null, null, true, this.token)
  }

  sendMessage(message, to = TEST_USER_ID) {
    this.post("message/push", {to, messages: [message]})
  }

  sendText(message, to) {
    if (Array.isArray(message)) {
      this.post("message/push", {
        to,
        messages: message.map(text => ({type: "text", text}))
      })
    } else {
      this.sendMessage({
        type: "text",
        text: `${message}`
      }, to)
    }
  }

  sendImage(url, to) {
    this.sendMessage({
      type: "image",
      originalContentUrl: url,
      previewImageUrl: `https://api.rethumb.com/v1/square/240/${url}`
    }, to)
  }

  sendTemplate({
    title, text, alt = "This is an alt text", thumbnail = defaultImage,
    actions = defaultAction
  }, to) {
    this.sendMessage({
      type: "template",
      altText: alt,
      template: {
        type: "buttons",
        thumbnailImageUrl: thumbnail,
        title,
        text,
        actions
      },
    }, to)
  }

}

const scripts = {
  "main": {}
}

const bot = new LineMessaging(CHANNEL_TOKEN)

class ChatStage extends MemoryService {
  // TODO: We need to store user's state in there.
  //       I'm thinking of Redis, but fuck it I'm tired.
  //       It's a hackathon, so yeah.
}

const initChat = id => {
  bot.sendTemplate({
    title: "р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕Др╕гр╕▒р╕Ъ р╕бр╕╡р╕нр╕░р╣Др╕гр╣Гр╕лр╣Йр╕Ыр╕гр╕╢р╕Бр╕йр╕▓р╣Др╕лр╕бр╕Др╕гр╕▒р╕Ъ? ЁЯШК ЁЯСК",
    text: "р╕Щр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╣Ар╕Др╕кр╕Чр╕╡р╣Ир╕Юр╕Ър╕Ър╣Ир╕нр╕в р╕Цр╣Йр╕▓р╕кр╕Зр╕кр╕▒р╕вр╕Щр╕нр╕Бр╣Ар╕лр╕Щр╕╖р╕нр╕Ир╕▓р╕Бр╕Щр╕╡р╣Йр╕Цр╕▓р╕бр╣Др╕Фр╣Йр╣Ар╕ер╕вр╕Щр╕░р╕Др╕гр╕▒р╕Ъ",
    alt: "Alt Message",
    thumbnail: "https://i.imgur.com/s4c7YSH.jpg",
    actions: [{
      type: "postback",
      label: "р╕лр╕Щр╕╡р╣Йр╕Ър╕▒р╕Хр╕гр╣Ар╕Др╕гр╕Фр╕┤р╕Х ЁЯТ│",
      data: "nomoney"
    }, {
      type: "postback",
      label: "р╣Др╕Фр╣Йр╕лр╕бр╕▓р╕вр╕ир╕▓р╕е тЪЦя╕П",
      data: "lawsuit"
    }, {
      type: "postback",
      label: "р╣Вр╕Фр╕Щр╕Хр╕│р╕гр╕зр╕Ир╕вр╕╢р╕Фр╕гр╕Ц ЁЯЪЧ",
      data: "policetookmycar"
    }, {
      type: "postback",
      label: "р╕Цр╕╣р╕Бр╣Бр╕нр╕Ър╕Цр╣Ир╕▓р╕вр╕ер╕Зр╣Вр╕Лр╣Ар╕Кр╕╡р╕вр╕е ЁЯУ╖",
      data: "paparazzis"
    }]
  }, id)
}

const REPLY = {
  "nomoney": [`р╣Гр╕Ир╣Ар╕вр╣Зр╕Щр╣Ж р╣Др╕Ыр╕Хр╕▓р╕бр╕ир╕▓р╕ер╕Щр╕▒р╕Ф р╕Др╕╕р╕вр╕Бр╕▒р╕Ър╕Чр╕Щр╕▓р╕вр╕Вр╕нр╕Зр╕Шр╕Щр╕▓р╕Др╕▓р╕гр╣Ар╕Ир╣Йр╕▓р╕Вр╕нр╕Зр╕Ър╕▒р╕Хр╕г р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕Вр╣Йр╕нр╣Ар╕кр╕Щр╕нр╕Вр╕нр╕Зр╕Шр╕Щр╕▓р╕Др╕▓р╕гр╕Бр╣Ир╕нр╕Щр╕Щр╕░ ЁЯШЙ`,
  `р╕Цр╣Йр╕▓р╣Ар╕гр╕▓р╣Др╕бр╣Ир╣Др╕лр╕з р╕ер╕нр╕Зр╕Хр╣Ир╕нр╕гр╕нр╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕ер╕╖р╣Ир╕нр╕Щр╕зр╕▒р╕Щр╕Ир╣Ир╕▓р╕вр╣Ар╕Зр╕┤р╕Щ р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕Щр╕▒р╣Йр╕Щр╕Чр╕▓р╕Зр╕ир╕▓р╕ер╕Ир╕░р╣Гр╕лр╣Йр╣Ар╕Лр╣Зр╕Щр╕кр╕▒р╕Нр╕Нр╕▓р╣Ар╕ер╕╖р╣Ир╕нр╕Щр╕зр╕▒р╕Щр╕Щр╕▒р╕Фр╕Др╕Фр╕╡ р╣Бр╕ер╣Йр╕зр╕Бр╕ер╕▒р╕Ър╕Ър╣Йр╕▓р╕Щр╣Др╕Фр╣Йр╣Ар╕ер╕в! ЁЯШК`,
  `р╣Бр╕Хр╣Ир╕Цр╣Йр╕▓р╣Ар╕гр╕▓р╣Др╕лр╕з р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕гр╕▓р╕вр╣Др╕Фр╣Й р╣Бр╕ер╣Йр╕зр╕Бр╣Зр╕Хр╕Бр╕ер╕Зр╕Бр╕▒р╕Ър╕Шр╕Щр╕▓р╕Др╕▓р╕гр╣Ар╕Юр╕╖р╣Ир╕нр╕Ьр╣Ир╕нр╕Щр╕Кр╕│р╕гр╕░р╕Хр╕▓р╕бр╕гр╕▓р╕вр╣Др╕Фр╣Йр╕Чр╕╡р╣Ир╕бр╕╡ р╣Бр╕Др╣Ир╕Щр╕▒р╣Йр╕Щр╣Ар╕нр╕З~`,
  `р╕Цр╣Йр╕▓р╕Чр╕▓р╕Зр╕Шр╕Щр╕▓р╕Др╕▓р╕гр╣Ар╕Др╣Йр╕▓р╕гр╕▒р╕Ър╣Др╕Фр╣Йр╕Бр╣Зр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ р╣Бр╕Хр╣Ир╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Бр╣Зр╕Хр╣Йр╕нр╕Зр╕вр╕нр╕бр╕Чр╕│р╕Хр╕▓р╕бр╕Др╕│р╕Хр╕▒р╕Фр╕кр╕┤р╕Щр╕Вр╕нр╕Зр╕ир╕▓р╕ер╕ер╣Ир╕░р╕Щр╕░ ЁЯСК`],

  "policetookmycar": [
    `р╕Цр╣Йр╕▓р╕гр╕Цр╣Ар╕гр╕▓р╕вр╕▒р╕Зр╕Ьр╣Ир╕нр╕Щр╣Др╕бр╣Ир╕лр╕бр╕Ф р╕Бр╣Зр╣Др╕Ыр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Др╕Яр╣Бр╕Щр╕Щр╕Лр╣Мр╣Гр╕лр╣Йр╣Ар╕Др╣Йр╕▓р╕Чр╕│р╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╕Вр╕нр╕Др╕╖р╕Щ ЁЯШ╢`,
    `р╣Бр╕Хр╣Ир╕Цр╣Йр╕▓р╣Ар╕гр╕▓р╕Ьр╣Ир╕нр╕Щр╕лр╕бр╕Фр╣Бр╕ер╣Йр╕з р╕Бр╣Зр╣Др╕Ыр╕вр╕╖р╣Ир╕Щр╕Др╕│р╕гр╣Йр╕нр╕Зр╕Хр╣Ир╕нр╕ир╕▓р╕ер╕ар╕▓р╕вр╣Гр╕Щ 1 р╕Ыр╕╡ р╣Др╕бр╣Ир╕нр╕вр╣Ир╕▓р╕Зр╕Щр╕▒р╣Йр╕Щр╕Ир╕░р╕Вр╕╢р╣Йр╕Щр╕зр╣Ир╕▓р╕кр╕╣р╕Нр╕лр╕▓р╕вр╕Щр╕░ ЁЯШЙ`
  ],

  "paparazzis": `р╣Гр╕Ир╣Ар╕вр╣Зр╕Щр╣Ж р╕Бр╣Ир╕нр╕Щ р╕гр╕╡р╕Ър╕гр╕зр╕Ър╕гр╕зр╕бр╕лр╕ер╕▒р╕Бр╕Рр╕▓р╕Щр╕Чр╕╡р╣Ир╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ р╣Бр╕ер╣Йр╕зр╣Др╕Ыр╣Ар╕Вр╣Йр╕▓р╣Бр╕Ир╣Йр╕Зр╕Др╕зр╕▓р╕бр╕Бр╕▒р╕Ър╕Хр╕│р╕гр╕зр╕Ир╕Щр╕░ ЁЯШК`,

  "P1": `р╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╣Бр╕ер╕░р╕кр╕│р╣Ар╕Щр╕▓р╕Др╕│р╕Яр╣Йр╕нр╕З р╕лр╕гр╕╖р╕н р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╕Др╕Фр╕╡р╣Бр╕Юр╣Ир╕Зр╕кр╕▓р╕бр╕▒р╕Н
р╕Хр╣Ир╕нр╕Чр╕│р╕Бр╕▓р╕гр╕Др╕│р╣Гр╕лр╣Йр╕Бр╕▓р╕гр╕вр╕╖р╣Ир╕Щр╕Хр╣Ир╕нр╕ир╕▓р╕ер╕ар╕▓р╕вр╣Гр╕Бр╕│р╕лр╕Щр╕Ф 15 р╕зр╕▒р╕Щ р╕Щр╕▒р╕Ър╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣Ир╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕лр╕бр╕▓р╕в`,

  "P2": [
    `р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╕Др╕Фр╕╡р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕вр╕╕р╣Ир╕Зр╕вр╕▓р╕Б р╕лр╕гр╕╖р╕н р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Др╕Фр╕╡р╕бр╣Вр╕Щр╕кр╕▓р╣Ар╕лр╕гр╣И`,
    `р╕Др╕Фр╕╡р╕бр╣Вр╕Щр╕кр╕▓р╣Ар╕лр╕гр╣И р╕Др╕╖р╕н р╕Др╕Фр╕╡р╕Чр╕╡р╣Ир╕Яр╣Йр╕нр╕Зр╕гр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╣Вр╕Фр╕вр╕бр╕╡р╕Чр╕╕р╕Щр╕Чр╕гр╕▒р╕Юр╕вр╣Мр╣Др╕бр╣Ир╣Ар╕Бр╕┤р╕Щ 40,000 р╕Ър╕▓р╕Ч`,
    `р╣Ар╕Кр╣Ир╕Щ р╕Яр╣Йр╕нр╕Зр╣Др╕ер╣Ир╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕нр╕кр╕▒р╕Зр╕лр╕▓р╕гр╕┤р╕бр╕Чр╕гр╕▒р╕Юр╕вр╣М р╕Чр╕╡р╣Ир╕бр╕╡р╕Др╣Ир╕▓р╣Ар╕Кр╣Ир╕▓р╕Вр╕Ур╕░р╕вр╕╖р╣Ир╕Щр╕Яр╣Йр╕нр╕Зр╣Др╕бр╣Ир╣Ар╕Бр╕┤р╕Щр╣Ар╕Фр╕╖р╕нр╕Щр╕ер╣Ир╕░ 4,000`,
    `р╕Ир╕│р╣Ар╕ер╕вр╕Хр╣Йр╕нр╕Зр╕бр╕▓р╕ир╕▓р╕ер╕Хр╕▓р╕бр╕зр╕▒р╕Щр╕Щр╕▒р╕Фр╣Ар╕Юр╕╖р╣Ир╕нр╣Др╕Бр╕ер╣Ир╣Ар╕Бр╕ер╕╡р╣Ир╕в`
  ],

  "A1": [
    `р╣Ар╕бр╕╖р╣Ир╕нр╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕лр╕бр╕▓р╕вр╕Щр╕▒р╕Ф р╕Хр╣Йр╕нр╕Зр╕Фр╕╣р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕зр╣Ир╕▓р╕ир╕▓р╕ер╕Бр╕│р╕лр╕Щр╕Фр╕зр╕▒р╕Щр╕Щр╕▒р╕Фр╣Др╕Хр╣Ир╕кр╕зр╕Щр╕бр╕╣р╕ер╕Яр╣Йр╕нр╕Зр╕зр╕▒р╕Щр╣Гр╕Ф тЪЦя╕П`,
    `р╕Цр╣Йр╕▓р╕Ир╕░р╕Хр╣Ир╕нр╕кр╕╣р╣Йр╕Др╕Фр╕╡р╕Хр╣Йр╕нр╕Зр╕Ыр╕гр╕╢р╕Бр╕йр╕▓р╕Чр╕Щр╕▓р╕вр╕Др╕зр╕▓р╕бр╕Чр╕▒р╕Щр╕Чр╕╡ р╣Ар╕Юр╕╖р╣Ир╕нр╕Ир╕░р╕Чр╕│р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╣Бр╕Хр╣Ир╕Зр╕Хр╕▒р╣Йр╕Зр╣Гр╕лр╣Йр╕Чр╕Щр╕▓р╕вр╣Др╕Ыр╕Чр╕│р╕Бр╕▓р╕гр╕Лр╕▒р╕Бр╕Др╣Йр╕▓р╕Щр╕Юр╕вр╕▓р╕Щр╣Вр╕Ир╕Чр╕Бр╣Мр╣Гр╕Щр╕зр╕▒р╕Щр╕Щр╕▒р╕Фр╣Др╕Хр╣Ир╕кр╕зр╕Щр╕бр╕╣р╕ер╕Яр╣Йр╕нр╕Зр╣Бр╕Чр╕Щ`,
    `р╣Гр╕Щр╕зр╕▒р╕Щр╕Щр╕▒р╕Фр╣Др╕Хр╣Ир╕кр╕зр╕Щр╕бр╕╣р╕ер╕Яр╣Йр╕нр╕З р╕Ир╕│р╣Ар╕ер╕вр╣Др╕бр╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕Хр╣Йр╕нр╕Зр╣Др╕Ыр╕ир╕▓р╕ер╕Бр╣Зр╣Др╕Фр╣Й ЁЯШЙ`
  ],

  "A2": [
    `р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╕Юр╕вр╕▓р╕Щр╕Ър╕╕р╕Др╕Др╕е р╣Ар╕бр╕╖р╣Ир╕нр╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕лр╕бр╕▓р╕вр╕Ир╕░р╕Хр╣Йр╕нр╕Зр╣Др╕Ыр╕ир╕▓р╕ер╕Хр╕▓р╕бр╕зр╕▒р╕Щр╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Фр╣Др╕зр╣Йр╣Гр╕Щр╕лр╕бр╕▓р╕в р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Ър╕┤р╕Бр╕Др╕зр╕▓р╕бр╣Ар╕Ыр╣Зр╕Щр╕Юр╕вр╕▓р╕Щр╕Хр╣Ир╕нр╕ир╕▓р╕е тЪЦя╕П`,
    `р╕лр╕▓р╕Бр╕Вр╕▒р╕Фр╕Вр╕╖р╕Щр╣Др╕бр╣Ир╣Др╕Ыр╕ир╕▓р╕ер╕Хр╕▓р╕бр╕Бр╕│р╕лр╕Щр╕Ф р╕ир╕▓р╕ер╕нр╕▓р╕Ир╕нр╕нр╕Бр╕лр╕бр╕▓р╕вр╕Ир╕▒р╕Ър╣Ар╕нр╕▓р╕Хр╕▒р╕зр╕Бр╕▒р╕Бр╕Вр╕▒р╕Зр╣Др╕Фр╣Й р╣Бр╕ер╕░р╕нр╕▓р╕Ир╕Цр╕╣р╕Бр╕Яр╣Йр╕нр╕Зр╣Др╕Фр╣Й ЁЯШо`
  ]
}

const gotLawsuit = id => {
  bot.sendTemplate({
    title: "р╕Др╕╕р╕Ур╣Др╕Фр╣Йр╕лр╕бр╕▓р╕вр╕ир╕▓р╕ер╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Бр╕Юр╣Ир╕З р╕лр╕гр╕╖р╕нр╕нр╕▓р╕Нр╕▓р╕Др╕гр╕▒р╕Ъ?",
    text: "р╣Ар╕гр╕▓р╕Ир╕░р╕Кр╣Ир╕зр╕вр╕Др╕╕р╕Ур╣Бр╕Щр╣Ир╣Ж р╕Др╕гр╕▒р╕Ъ р╣Бр╕Хр╣Ир╕гр╕Ър╕Бр╕зр╕Щр╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╕Бр╣Ир╕нр╕Щр╕Щр╕░р╕Др╕гр╕▒р╕Ъ ЁЯЩВ",
    actions: [{
      type: "postback",
      label: "р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Др╕Фр╕╡р╣Бр╕Юр╣Ир╕З тЪЦя╕П",
      data: "RektP"
    }, {
      type: "postback",
      label: "р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Др╕Фр╕╡р╕нр╕▓р╕Нр╕▓ ЁЯФк",
      data: "RektA"
    }]
  }, id)
}

const e = (msg, m = 1) => {
  if (msg) {
    if (msg.length > m) {
      return true
    }
  }
  return false
}

const JOKES = [
  "р╕гр╣Йр╕нр╕вр╕Ыр╕╡р╕Чр╕╡р╣Ир╣Бр╕ер╣Йр╕зр╕Щр╕╡р╣Ир╣Ар╕Вр╕▓р╣Ар╕ер╣Ир╕Щ April Fools Day р╕Бр╕▒р╕Щр╣Бр╕гр╕Зр╣Ар╕Щр╕▓р╕░ ЁЯЩД",
  "р╕Хр╕░р╕бр╕╕р╕Хр╕░р╕бр╕┤ ЁЯШЙ",
  "р╣Ар╕Фр╕╡р╣Лр╕вр╕зр╕Чр╕╕р╣Ир╕бр╕Фр╣Йр╕зр╕вр╣Вр╕Юр╣Ар╕Фр╕╡р╣Йр╕вр╕б ЁЯЩД",
  "р╕Ыр╕▒р╣Кр╕Фр╣Вр╕Шр╣Ир╕зр╕зр╕зр╕зр╕зр╕зр╕зр╕зр╕з ЁЯЩД"
]

const JOKE_REPLY = {
  "р╣Ар╕бр╕╖р╣Ир╕нр╣Др╕гр╕Ир╕░р╕нр╕нр╕Б": "р╕Др╕Щр╣Др╕Чр╕вр╕Эр╕▓р╕Бр╕нр╕Щр╕▓р╕Др╕Хр╣Др╕зр╣Йр╕Бр╕▒р╕Ър╕Ьр╕б р╣Др╕Фр╣Йр╕вр╕┤р╕Щр╕Чр╕╡р╣Др╕гр╕Щр╣Йр╕│р╕Хр╕▓р╣Др╕лр╕ер╕Чр╕╕р╕Бр╕Чр╕╡ ЁЯШЙ",
  "р╕Др╕зр╕в": "р╣Ар╕Фр╕╡р╣Ир╕вр╕зр╕Чр╕╕р╕бр╕Фр╣Йр╕зр╕вр╣Вр╕Юр╣Ар╕Фр╕╡р╣Йр╕вр╕бр╕лр╕гр╕нр╕Б р╕Ыр╕▒р╕Чр╣Вр╕Шр╣И ЁЯЩД",
  "р╣Ар╕Ир╕нр╣Др╕Фр╣Йр╕Щр╕░р╕Хр╕╣р╣И": "р╕Цр╣Йр╕▓р╣Ар╕Ър╕╖р╣Ир╕нр╕Ьр╕бр╕Бр╣Зр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Кр╣Ир╕нр╕З ЁЯЩД",
  "р╣Ар╕лр╣Зр╕Ър╕лр╕бр╕▓": "р╣Ар╕нр╕▓р╣Др╕Ыр╕Вр╕▓р╕вр╕Чр╕╡р╣Ир╕Фр╕▓р╕зр╕нр╕▒р╕Зр╕Др╕▓р╕г р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕гр╕▓р╕Др╕▓р╕Фр╕╡ ЁЯЩД",
  "р╣Ар╕Ър╕╖р╣Ир╕нр╕Хр╕╣р╣И": "р╣Др╕лр╕Щр╣Гр╕Др╕гр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╕нр╕░р╣Др╕г р╣Др╕Ыр╕Др╕╕р╕вр╕Бр╕▒р╕Щр╕Чр╕╡р╣Ир╕Др╣Ир╕▓р╕в ЁЯШЙ",
  "р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Шр╕┤р╕Ыр╣Др╕Хр╕в": "р╣Др╕бр╣Ир╕нр╕нр╕Б р╣Гр╕Др╕гр╕Ир╕░р╕нр╕нр╕Б р╕Ьр╕бр╣Др╕бр╣Ир╕нр╕нр╕Б ЁЯЩД",
  "р╕Др╕кр╕К р╕Др╕╖р╕нр╣Др╕г": "р╕Чр╕лр╕▓р╕гр╕Хр╕нр╕Ър╣Др╕Фр╣Й р╕Цр╕▓р╕бр╕Ыр╣Ир╕▓р╕з ЁЯШЙ",
  "р╕Хр╕░р╕бр╕╕р╕Хр╕░р╕бр╕┤": "р╕Ьр╕бр╣Ар╕Юр╕╖р╣Ир╕нр╕Щр╣Ар╕ер╣Ир╕Щр╕Др╕╕р╕Ур╣Ар╕лр╕гр╕н р╕Чр╕╕р╣Ар╕гр╕╡р╕вр╕Щ ЁЯЩД",
  "р╕Ыр╕гр╕░р╣Ар╕Чр╕ир╕Щр╕╡р╣Йр╕Вр╕нр╕Зр╣Гр╕Др╕г": "р╕Вр╕нр╕Зр╕Ьр╕бр╕Ир╕Ър╕Ыр╕┤р╣Йр╕З ЁЯШЙ",
  "р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕ер╕╕р╕З": "р╣Ар╕нр╕▓р╕Бр╕нр╕Зр╣Др╕зр╣Йр╕Хр╕гр╕Зр╕Щр╕▒р╣Йр╕Щр╣Бр╕лр╕ер╕░ р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕бр╕╡р╕Др╕зр╕▓р╕бр╕кр╕│р╕Др╕▒р╕Нр╕нр╕░р╣Др╕г ЁЯШЙ",
  "р╕Щр╕нр╕Щр╕Бр╣Ир╕нр╕Щ": "р╣Ар╕Ир╕гр╕┤р╕Нр╕Юр╕г р╕Кр╕┤р╕Хр╕▒р╕Зр╣Ар╕б р╣Вр╕Ыр╣Йр╕З р╕гр╕зр╕вр╣Ж ЁЯШЙ"
}

/*
  Object.keys(o).forEach(e => {
    if ("namelol".match(e)) {
      console.log("WTF")
    }
  })
*/

const suggestLawyer = id => {
  setTimeout(() => {
    bot.sendTemplate({
      title: "р╕Др╕╕р╕Ур╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╕Др╕│р╕Ыр╕гр╕╢р╕Бр╕йр╕▓р╕Ир╕▓р╕Бр╕Чр╕Щр╕▓р╕вр╕Яр╕гр╕╡р╣Др╕лр╕бр╕Др╕гр╕▒р╕Ъ ЁЯШК",
      text: "р╕Др╕Фр╕╡р╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╕Чр╕Щр╕▓р╕вр╕Др╕зр╕▓р╕б р╣Бр╕ер╕░р╣Ар╕гр╕▓р╕Ир╕░р╕Кр╣Ир╕зр╕вр╕Др╕╕р╕Ур╣Гр╕лр╣Йр╕Цр╕╢р╕Зр╕Чр╕╡р╣Ир╕кр╕╕р╕Фр╕Др╕гр╕▒р╕Ъ ЁЯШК",
      thumbnail: "https://i.imgur.com/s4c7YSH.jpg",
      actions: [{
        type: "postback",
        label: "р╕лр╕▓р╕Чр╕Щр╕▓р╕вр╣Гр╕лр╣Йр╕лр╕Щр╣Ир╕нр╕вр╕кр╕┤ ЁЯСН",
        data: "getlawyer"
      }, {
        type: "postback",
        label: "р╣Др╕бр╣И ЁЯЪл",
        data: "noneed"
      }]
    }, id)
  }, 800)
}

class WebHookHandler {
  find = () => Promise.resolve({data: "OK v4"})

  create = (data = {}) => {
    console.log("Incoming POST request:", JSON.stringify(data))

    // bot.sendText(`Incoming Msg: ${JSON.stringify(data)}`)

    if (data.events) {
      data.events.forEach(msg => {
        const id = msg.source.userId

        if (msg.type === "message") {
          const text = msg.message.text

          if (e(text.match(/р╕Ър╕▒р╕Хр╕г|р╕Ыр╕гр╕░р╕Кр╕▓/g))) {
            bot.sendText(`р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Хр╕гр╕╡р╕вр╕б р╕Др╕╖р╕н р╕Ър╕▒р╕Хр╕гр╕Чр╕╡р╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щр╕Чр╕╡р╣Ир╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕▒р╕Рр╕нр╕нр╕Бр╣Гр╕лр╣Й р╕лр╕гр╕╖р╕нр╕кр╕│р╣Ар╕Щр╕▓р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕Ър╣Йр╕▓р╕Щ ЁЯШД`, id)
            // bot.sendImage(`https://i.imgur.com/z8C0ESs.jpg`, id)
          } else if (e(text.match(/р╕Чр╕│|р╕Юр╕▓р╕кр╕Ыр╕нр╕гр╣Мр╕Х|Passport/gi))) {
            bot.sendText(`р╕Ир╕нр╕Зр╕Др╕┤р╕зр╣Бр╕ер╕░р╕Фр╕╣р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕Чр╕│р╕Юр╕▓р╕кр╕Ыр╕нр╕гр╣Мр╕Хр╕Чр╕╡р╣И https://www.passport.in.th ЁЯШД`, id)
            bot.sendImage(`https://i.imgur.com/VRItpao.jpg`, id)
          } else if (text.match(/р╕лр╕бр╕▓р╕вр╕ир╕▓р╕е/g)) {
            gotLawsuit(id)
          } else if (text.match(/р╕Ър╣Йр╕▓р╕Щр╕гр╕╕р╕Бр╕ер╣Йр╕│/g)) {
            bot.sendText([
              `р╣Ар╕Ир╣Йр╕▓р╕Вр╕нр╕Зр╕Чр╕╡р╣Ир╕Фр╕┤р╕Щр╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Ар╕нр╕▓р╕Др╕╖р╕Щр╕Чр╕╡р╣Ир╕Фр╕┤р╕Щр╕Ир╕▓р╕Бр╣Ар╕Юр╕╖р╣Ир╕нр╕Щр╕Ър╣Йр╕▓р╕Щр╕Чр╕╡р╣Ир╕гр╕╕р╕Бр╕ер╣Йр╕│р╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╣Вр╕Фр╕вр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤ ЁЯТб (р╕Ы.р╕Ю.р╕Ю. р╕бр╕▓р╕Хр╕гр╕▓ 1336)`,
              `р╕Хр╣Йр╕нр╕Зр╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕лр╣Йр╣Ар╕Юр╕╖р╣Ир╕нр╕Щр╕Ър╣Йр╕▓р╕Щр╕гр╕╖р╣Йр╕нр╕Цр╕нр╕Щр╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕гр╕╕р╕Бр╕ер╣Йр╕│ р╣Бр╕ер╣Йр╕зр╕Чр╕│р╕Чр╕╡р╣Ир╕Фр╕┤р╕Щр╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щр╕Хр╕▓р╕бр╣Ар╕Фр╕┤р╕б р╕Ьр╕╣р╣Йр╕кр╕гр╣Йр╕▓р╕Зр╕Кр╣Ир╕зр╕вр╕нр╕нр╕Бр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Др╕Фр╣Й ЁЯШЙ (р╕Ы.р╕Ю.р╕Ю. р╕бр╕▓р╕Хр╕гр╕▓ 1312 р╕зр╕гр╕гр╕Д 2)`
            ], id)
          } else if (text.match(/р╕лр╕Щр╕╡р╣Йр╕Ър╕▒р╕Хр╕гр╣Ар╕Др╕гр╕Фр╕┤р╕Х/g)) {
            bot.sendText(REPLY.nomoney, id)
          } else if (text.match(/р╕Хр╕│р╕гр╕зр╕Ир╕вр╕╢р╕Фр╕гр╕Ц/g)) {
            bot.sendText(REPLY.policetookmycar, id)
          } else if (text.match(/р╣Бр╕нр╕Ър╕Цр╣Ир╕▓р╕в/g)) {
            bot.sendText(REPLY.paparazzis, id)
          } else if (text.match(/р╕Вр╕нр╕Ър╕Др╕╕р╕У|thank/gi)) {
            bot.sendText(`р╕Вр╕нр╕Ър╕Др╕╕р╕Ур╕бр╕▓р╕Бр╕Др╕гр╕▒р╕Ъ р╕Ыр╕╡р╕лр╕Щр╣Йр╕▓р╣Гр╕лр╣Йр╕Ьр╕бр╣Ар╕Ыр╣Зр╕Щр╕Щр╕▓р╕вр╕Бр╕Хр╣Ир╕нр╕Фр╣Йр╕зр╕вр╕Щр╕░ ЁЯШЙ`, id)
          } else if (text.match(/Never Gonna Give You Up/gi)) {
            bot.sendText(`Never Gonna Let You Down~! ЁЯШЙ`, id)
          } else if (text.match(/р╣Бр╕Ър╕Ър╕Яр╕нр╕гр╣Мр╕бр╕ир╕▓р╕е/)) {
            bot.sendText(`р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╣Бр╕Ър╕Ър╕Яр╕нр╕гр╣Мр╕бр╕ир╕▓р╕ер╣Др╕Фр╣Йр╕Чр╕╡р╣И http://www.chawbanlaw.com/form_download.html р╕Щр╕░р╕Др╕гр╕▒р╕Ъ~! ЁЯШЙ`, id)
          } else if (JOKE_REPLY[text]) {
            bot.sendText(JOKE_REPLY[text], id)
          } else if (text.match(/р╕кр╕зр╕▒р╕кр╕Фр╕╡|р╕лр╕зр╕▒р╕Фр╕Фр╕╡|Hello|Hey|Hi|Yo/gi)) {
            initChat(id)
          } else {
            bot.sendText(JOKES[Math.floor(Math.random() * JOKES.length)], id)
          }
        }

        if (msg.type === "follow") {
          // User added you as a friend
          initChat(id)
        }

        if (msg.type === "postback") {
          const choice = msg.postback.data

          if (REPLY[choice]) {
            bot.sendText(REPLY[choice], id)

            if (choice.match(/P1|P2|A1|A2/g)) {
              suggestLawyer(id)
            }
          }

          if (choice === "getlawyer") {
            bot.sendText(`р╕Чр╕Щр╕▓р╕вр╕Др╕зр╕▓р╕бр╕Вр╕нр╕Зр╣Ар╕гр╕▓р╕Бр╕│р╕ер╕▒р╕Зр╕Ир╕░р╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Др╕Ыр╕лр╕▓р╕Чр╣Ир╕▓р╕Щ р╕Вр╕нр╣Гр╕лр╣Йр╕Чр╣Ир╕▓р╕Щр╕Кр╕Щр╕░р╕Др╕Фр╕╡р╕Щр╕░р╕Др╕гр╕▒р╕Ъ ЁЯШД`, id)
          }

          if (choice === "lawsuit") {
            gotLawsuit(id)
          }

          if (choice === "RektP") {
            bot.sendTemplate({
              title: "р╕гр╕Ър╕Бр╕зр╕Щр╕Ър╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Вр╕нр╕Зр╕лр╕бр╕▓р╕вр╕ир╕▓р╕ер╕Др╕Фр╕╡р╣Бр╕Юр╣Ир╕Зр╕Фр╣Йр╕зр╕вр╕Др╕гр╕▒р╕Ъ тЬМя╕П",
              text: "....",
              actions: [{
                type: "postback",
                label: "р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╕Др╕Фр╕╡р╣Бр╕Юр╣Ир╕Зр╕кр╕▓р╕бр╕▒р╕Н",
                data: "P1"
              }, {
                type: "postback",
                label: "р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╕Др╕Фр╕╡р╕бр╣Вр╕Щр╕кр╕▓р╣Ар╕лр╕гр╣И",
                data: "P2"
              }]
            }, id)
          }

          if (choice === "RektA") {
            bot.sendTemplate({
              title: "р╕гр╕Ър╕Бр╕зр╕Щр╕Ър╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Вр╕нр╕Зр╕лр╕бр╕▓р╕вр╕ир╕▓р╕ер╕Др╕Фр╕╡р╕нр╕▓р╕Нр╕▓р╕Фр╣Йр╕зр╕вр╕Др╕гр╕▒р╕Ъ тЬМя╕П",
              text: "....",
              actions: [{
                type: "postback",
                label: "р╕лр╕бр╕▓р╕вр╕Щр╕▒р╕Фр╣Др╕Хр╣Ир╕кр╕зр╕Щр╕бр╕╣р╕ер╕Яр╣Йр╕нр╕З",
                data: "A1"
              }, {
                type: "postback",
                label: "р╕лр╕бр╕▓р╕вр╣Ар╕гр╕╡р╕вр╕Бр╕Юр╕вр╕▓р╕Щр╕Ър╕╕р╕Др╕Др╕е",
                data: "A2"
              }]
            }, id)
          }

        }
      })
    }

    return Promise.resolve({data: "200"})
  }
}

export default function debug() {
  this.use("linehook", new WebHookHandler(), (req, res, next) => {
    res.status(200)
    next()
  })
}
